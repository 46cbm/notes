# 9 事务 全球化和本地化 安全管理 数据库维护

## 9.1 事务

事务处理（transaction processing）可以用来维护数据库的完整性。它保证成批的MySQL语句要么完全执行，要么完全不执行。下面是关于事务的几个术语：

- 回退(rollback)：撤销指定的SQL语句
- 提交(commit)：将未存入的SQL语句结果写入数据库表
- 保留点(savepoint)：指事务处理中设置的临时占位符，你可以对它发布回退（不同于回退整个事务）

使用ROLLBACK或COMMIT后，事务会关闭。

### 使用ROLLBACK

我们delete之后，select为空，rollback之后再select，数据又恢复了。

注意只有INSERT、UPDATE和DELETE能被ROLLBACK

```sql
mysql> SELECT * FROM ordertotals;
+-----------+---------+
| order_num | total   |
+-----------+---------+
|     20005 |  158.86 |
|     20009 |   40.78 |
|     20006 |   58.30 |
|     20007 | 1060.00 |
|     20008 |  132.50 |
|     20008 |  132.50 |
+-----------+---------+
6 rows in set (0.01 sec)

mysql> START TRANSACTION;
Query OK, 0 rows affected (0.01 sec)

mysql> DELETE FROM ordertotals;
Query OK, 6 rows affected (0.02 sec)

mysql> SELECT * FROM ordertotals;
Empty set (0.00 sec)

mysql> ROLLBACK;
Query OK, 0 rows affected (0.01 sec)

mysql> SELECT * FROM ordertotals;
+-----------+---------+
| order_num | total   |
+-----------+---------+
|     20005 |  158.86 |
|     20009 |   40.78 |
|     20006 |   58.30 |
|     20007 | 1060.00 |
|     20008 |  132.50 |
|     20008 |  132.50 |
+-----------+---------+
```

### 使用COMMIT

一般的SQL语句是自动提交的，事务中的语句不会自动提交。

```sql
START TRANSACTION;
DELETE FROM orderitems WHERE order_num = 20010;
DELETE FROM orders WHERE order_num = 20010;
COMMIT;
```

### 使用保留点

ROLLBACK直接使用会撤销整个事务，如果想撤销部分事务，用保留点便可以实现

```sql
SAVEPOINT delete1;
...
some sql statements...
...
ROLLBACK TO delete1;
```

### 更改默认的提交行为

前面说过事务的外的操作默认会自动提交，如果不想自动提交，可以设置autocommit的值来实现。autocommit这个标志是正对每个连接，而不是服务器使用的。

```sql
SET autocommit=0;
```

