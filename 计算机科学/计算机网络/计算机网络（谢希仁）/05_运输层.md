# 5 运输层

## 5.1 运输层协议概述

### 进程之间的通信

运输层属于面向通信部分的最高层，同时也是用户功能中的最底层。

网络层为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信。

运输层还要对收到的报文进行差错检测。IP数据报首部中的检验和字段，只检验首部是否出现差错，不检查数据部分。

### 运输层的端口

注意路由器或交换机上的`硬件端口`是完全不同的概念。`硬件端口`是不同硬件设备进行交互的接口。`软件端口`则是应用层的各种协议进程与运输实体之间交互的一种地址。

TCP/IP的运输层采用16位的端口号标志端口。分为两类：

- 服务器使用的端口号
  这里又分两类：
  - 熟知端口号：0-1023。IANA把这些端口号给了TCP/IP最重要的一些应用程序。
  - 登记端口号：1024-49151。这类端口号的使用需要在IANA登记，防止重复。

- 客户端使用的端口号
  数值为49152-65535。这类端口号仅在客户进程运行时才动态选择。当服务器进程收到客户进程的报文时。就知道了客户进程的端口号，因而可以把数据发送给客户进程。通信结束后，客户端口号就不存在，可以供其他进程使用。

## 5.2 用户数据报协议 UDP

用户数据报协议只在IP的数据报服务至上增加了很少一点功能：复用和分用、差错检测。UDP的主要特点：

- 无连接
- 尽最大努力交付，即不保证可靠交付
- 面向报文。直接把应用层交下来的报文加上头部后给网络层，网络层自己再拆分。因此应用程序最好选择合适大小的报文。
- 没有拥塞控制
- 支持一对一、一对多、多对一、多对多
- 首部开销小，只有8个字节

UDP首部一共四个字段，每个字段两个字节，分别是：

- 源端口
- 目的端口
- 长度，包括了数据的总长度
- 检验和。注意IP首部的检验和只检验首部，UDP的检验和检验首部+数据

虽然UDP之间的通信要用到其端口号，但由于UDP的通信是无连接的，因此不需要使用套接字

## 5.3 传输控制协议TCP概述

### TCP最主要的特点

- 面向连接
- 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点（一对一）
- 提供可靠交付的服务
- 提供全双工通信。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP在连接的两端都设有发送缓存和接受缓存
- 面向字节流。TCP把应用进程交下来的数据仅仅看做是一连串无结构的字节流。

另外，TCP并不关心应用进程一次把多长的报文发送到TCP缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文应该包含多少字节。

### TCP的连接

TCP连接的端点为套接字。一个套接字就是一个IP和端口号的组合。
